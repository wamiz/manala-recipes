##################################################################
# This file is automatically generated when running "manala up". #
##################################################################

version: '3.6'

{{- $has_mariadb := .Vars.system.mariadb.version -}}
{{- $has_redis := .Vars.system.redis.version -}}
{{- $has_mailcatcher := .Vars.system.mailcatcher.version -}}
{{- $has_meilisearch := .Vars.system.meilisearch.version -}}

{{ if or ($has_mariadb) ($has_redis) ($has_meilisearch) }}

volumes:
    {{ if $has_mariadb -}}
    db-data:
    {{- end }}
    {{ if $has_redis -}}
    redis-data:
    {{- end }}
    {{ if $has_meilisearch -}}
    meilisearch-data:
    {{- end }}
{{- end }}

services:

{{- if $has_mariadb -}}
{{- $mariadb := .Vars.system.mariadb }}

  database:
    image: 'mariadb:{{ $mariadb.version }}'
    ports: [3306]
    command: --max_allowed_packet=1024M
    environment:
      MYSQL_USER: 'app'
      MYSQL_PASSWORD: 'app'
      MYSQL_DATABASE: 'app'
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
      TZ: {{ .Vars.system.timezone }}
    volumes:
      - db-data:/var/lib/mysql
      - .manala/init-db:/docker-entrypoint-initdb.d
      - .manala/config-db/99-additional-config.cnf:/etc/mysql/mariadb.conf.d/99-additional-config.cnf
    healthcheck:
      test: mysqladmin ping --silent
      interval: 10s
      timeout: 5s
      retries: 5

{{- end }}

{{- if $has_mariadb }}

  phpmyadmin:
    image: phpmyadmin
    ports: [80]
    environment:
      PMA_HOST: 'database'
      PMA_USER: 'app'
      PMA_PASSWORD: 'app'

{{- end }}

{{- if $has_redis }}

  redis:
    image: 'redis:alpine'
    ports: [6379]
    environment:
      TZ: {{ .Vars.system.timezone }}
    volumes:
      - redis-data:/data

  phpredisadmin:
    image: erikdubbelboer/phpredisadmin
    ports: [80]
    environment:
      REDIS_1_HOST: 'redis'

{{- end }}

{{- if $has_mailcatcher }}

  mailcatcher:
    image: 'schickling/mailcatcher'
    ports: [1025, 1080]
    environment:
      TZ: {{ .Vars.system.timezone }}

{{- end }}

{{- if $has_meilisearch }}

  meilisearch:
    image: 'getmeili/meilisearch:latest'
    ports: [7700]
    environment:
      TZ: {{ .Vars.system.timezone }}
    volumes:
      - meilisearch-data:/meili_data
    healthcheck:
      test: curl --silent --fail http://localhost:7700/health
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      com.symfony.server.service-prefix: 'MEILISEARCH'

{{- end }}
